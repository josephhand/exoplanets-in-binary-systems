#!/bin/env python

import numpy as np
import scipy.constants as const
import spright

import pandas as pd

from sys import argv as args
import tqdm

radius_bins = np.log10(np.array([0.5, 0.71, 1.0, 1.14, 2.0, 2.83, 4.0, 5.66, 8.0, 11.31, 16.0]))
period_bins = np.log10(np.array([0.78, 1.56, 3.13, 6.25, 12.5, 25, 50, 100, 200, 400]))

bin_weights_total = np.array(
    [
        [0.02, 0.1, 0.34, 0.18, 0, 0, 0, 0, 0],
        [0.1, 0.25, 0.71, 0.51, 0.26, 0.25, 0.28, 0, 0],
        [0.18, 0.46, 1.37, 2.34, 1.59, 0.43, 0.33, 0.41, 0],
        [0.12, 0.52, 1.79, 2.66, 2.41, 2.19, 1.5, 1.04, 0.57],
        [0.01, 0.1, 0.99, 3.37, 6.56, 7.57, 6.52, 6.01, 4.78],
        [0.01, 0.05, 0.27, 0.61, 2.13, 3.45, 3.62, 2.82, 2.21],
        [0.01, 0.02, 0.18, 0.17, 0.19, 0.26, 0.92, 0.67, 1.31],
        [0, 0, 0.08, 0.07, 0.24, 0.27, 0.53, 0.86, 2.75],
        [0, 0.01, 0.09, 0.16, 0.06, 0.2, 0.58, 1.55, 1.09],
        [0.02, 0.09, 0.19, 0.18, 0.18, 0.3, 0.37, 0.81, 1.66],
    ]
)

bin_weights_f = np.array(
    [
        [0, 0.03, 0.11, 0, 0, 0, 0, 0, 0],
        [0.02, 0.08, 0.27, 0.2, 0.19, 0, 0, 0, 0],
        [0.04, 0.25, 0.86, 1.25, 1.0, 0.34, 0.4, 0, 0],
        [0.03, 0.14, 0.54, 1.58, 1.08, 0.73, 0.6, 0.62, 0],
        [0.02, 0.04, 0.4, 1.08, 2.82, 4.25, 2.96, 2.96, 1.43],
        [0.01, 0.03, 0.189, 0.49, 1.27, 1.4, 2.33, 1.21, 1.6],
        [0, 0, 0.13, 0.08, 0.26, 0.52, 1.04, 0, 1.05],
        [0, 0, 0.06, 0.09, 0.1, 0.26, 0.56, 0.63, 1.48],
        [0, 0, 0, 0.1, 0, 0, 0.54, 0.71, 0.99],
        [0.02, 0.06, 0.13, 0.2, 0.17, 0.27, 0.46, 1.08, 1.08],
    ]
)

bin_weights_g = np.array(
    [
        [0.03, 0.17, 0.49, 0.39, 0, 0, 0, 0, 0],
        [0.14, 0.33, 1.04, 0.57, 0.66, 0.34, 0, 0, 0],
        [0.23, 0.54, 1.58, 3.12, 1.15, 0.41, 0.57, 0, 0],
        [0.13, 0.78, 2.56, 3.44, 3.18, 2.47, 1.2, 1.48, 0],
        [0, 0.13, 1.14, 4.12, 8.43, 10.48, 10.2, 7.23, 8.48],
        [0.02, 0.07, 0.3, 1.05, 2.89, 5.94, 4.56, 4.83, 1.95],
        [0.02, 0.05, 0.23, 0.34, 0.23, 0.39, 1.47, 1.79, 2.42],
        [0, 0, 0.1, 0.12, 0.34, 0.22, 0.67, 1.68, 5.63],
        [0, 0.03, 0.18, 0.16, 0.16, 0.34, 0.53, 2.98, 1.79],
        [0.02, 0.16, 0.34, 0.26, 0.26, 0.49, 0.58, 0.88, 2.02],
    ]
)

bin_weights_k = np.array(
    [
        [0.1, 0.22, 0.72, 0.47, 0, 0, 0, 0, 0],
        [0.3, 0.66, 1.19, 1.38, 0.94, 1.37, 1.39, 0, 0],
        [0.61, 1.04, 2.67, 4.26, 3.84, 2.34, 1.61, 2.65, 0],
        [0.4, 1.2, 4.36, 4.95, 5.52, 6.48, 6.45, 4.07, 3.74],
        [0, 0.35, 2.8, 9.25, 15.39, 15.55, 10.09, 13.12, 5.19],
        [0, 0.18, 0.59, 0.41, 2.87, 3.31, 5.28, 3.96, 10.01],
        [0, 0, 0.29, 0.42, 0.76, 0.74, 0, 1.7, 3.64],
        [0, 0, 0.24, 0, 0.81, 1.02, 1.18, 0, 0],
        [0, 0, 0.22, 0.46, 0, 1.01, 1.5, 1.64, 3.9],
        [0.08, 0.12, 0, 0, 0.45, 0, 0, 2.25, 6.52],
    ]
)


def generate_planet(weights):
    idx = np.random.choice(weights.size, p=weights.ravel() / float(weights.sum()))
    bin_index = np.unravel_index(idx, weights.shape)

    min_radius = radius_bins[bin_index[0]]
    max_radius = radius_bins[bin_index[0] + 1]

    min_period = period_bins[bin_index[1]]
    max_period = period_bins[bin_index[1] + 1]

    radius = 10**(np.random.rand() * (max_radius - min_radius) + min_radius)
    period = 10**(np.random.rand() * (max_period - min_period) + min_period)

    return (radius, period / 365)


ids = range(10000)
data = []

rmr = spright.RMRelation()

for id in tqdm.tqdm(ids):
    r, p = (10, 0)

    while r > 6:
        r, p = generate_planet(bin_weights_total)

    m = rmr.predict_mass(r)

    data.append([str(id), r, np.random.choice(m.samples), p])

df = pd.DataFrame(
    data,
    columns=["id", "radius", "mass", "period"],
)

df.to_csv(args[1])
